#2024
library(openxlsx)
# Base=read.xlsx("sav2024_E.xlsx")
# binary.data2024=read.xlsx("../Aprobación_Gobernador_Encuesta/SAV_2024_Pre_2.xlsx")
A=binary.data2024

#####HOMOLOGAR##################################################################

#####JUNTAR#####################################################################
N=nrow(A)

#P17 Principal problema colonia
unique(A$principal_problema_colonia) #Son 30

Mediaoriginal=N/length(unique(A$principal_problema_colonia))

R= A |>
  dplyr::group_by(principal_problema_colonia) |>
  dplyr::summarise(conteo = dplyr::n())

barplot(R$conteo,names.arg=R$principal_problema_colonia)

D=R[R$conteo<Mediaoriginal,]
D$principal_problema_colonia |> sort()
G=R[R$conteo>=Mediaoriginal,]

A$principal_problema_colonia[A$principal_problema_colonia=="Desempleo" | A$principal_problema_colonia=="Pobreza"]=
  "Economía"

A$principal_problema_colonia[A$principal_problema_colonia=="Basura"]=
  "Contaminación" 

A$principal_problema_colonia[A$principal_problema_colonia=="Drenaje" | A$principal_problema_colonia=="Electricidad"]=
  "Servicios Públicos"


#P32A1	Principalmente, ¿qué tipo de delito cree que ocurrió más en Hidalgo en el último año?
Mediaoriginal=N/length(unique(A$principal_delito))
R= A |>
  dplyr::group_by(principal_delito) |>
  dplyr::summarise(conteo = dplyr::n())

barplot(R$conteo,names.arg=R$principal_delito)
D=R[R$conteo<Mediaoriginal,]
D$principal_delito |> sort()
G=R[R$conteo>=Mediaoriginal,]
A$principal_delito[A$principal_delito=="Levantones"]=
  "Secuestro"

A$principal_delito <- as.character(A$principal_delito)

A$principal_delito[A$principal_delito %in% c("Robo de automóviles", "Robo de ganado", "Robo de hidrocarburos")] <- 
  "Robo de hidrocarburos / automóviles / ganado"
A$principal_delito[A$principal_delito=="Robo de automóviles" | A$principal_delito=="Robo de ganado" | A$principal_delito=="Robo de hidrocarburos"]=
  "Robo de hidrocarburos / automóviles / ganado"
A$principal_delito[A$principal_delito=="Violencia familiar" | A$principal_delito=="Violencia sexual"]=
  "Violencia familiar / sexual"

A$principal_delito <- as.factor(A$principal_delito)


#P44	¿En dónde o en qué aspecto considera que hay más corrupción?
Mediaoriginal=N/length(unique(A$donde_hay_mas_corrupcion))
R= A |>
  dplyr::group_by(donde_hay_mas_corrupcion) |>
  dplyr::summarise(conteo = dplyr::n())

barplot(R$conteo,names.arg=R$donde_hay_mas_corrupcion)
D=R[R$conteo<Mediaoriginal,]
D$donde_hay_mas_corrupcion |> sort()
G=R[R$conteo>=Mediaoriginal,]

A$donde_hay_mas_corrupcion[A$donde_hay_mas_corrupcion=="Obras Públicas"]=
  "Administración de Recursos"



#P99A1	Principalmente, ¿por cuál medio de comunicación se informa usted de noticias?
#P100A1 Principalmente, ¿por cuál medio de comunicación se informa usted de noticias?
Mediaoriginal=N/length(unique(A$medio_de_comunicacion_informa_noticias))
R= A |>
  dplyr::group_by(medio_de_comunicacion_informa_noticias) |>
  dplyr::summarise(conteo = dplyr::n())

barplot(R$conteo,names.arg=R$medio_de_comunicacion_informa_noticias)
D=R[R$conteo<Mediaoriginal,]
D$medio_de_comunicacion_informa_noticias |> sort()
G=R[R$conteo>=Mediaoriginal,]
A$medio_de_comunicacion_informa_noticias[A$medio_de_comunicacion_informa_noticias=="Twitter" | A$medio_de_comunicacion_informa_noticias=="Facebook" | A$medio_de_comunicacion_informa_noticias=="Youtube" | A$medio_de_comunicacion_informa_noticias=="Instagram" | 
                                           A$medio_de_comunicacion_informa_noticias=="TikTok"]=
  "Redes sociales"

#P13	¿Cuál considera que es el principal problema que enfrenta el estado de Hidalgo?
Mediaoriginal=N/length(unique(A$principal_problema_estado))

R= A |>
  dplyr::group_by(principal_problema_estado) |>
  dplyr::summarise(conteo = dplyr::n())

barplot(R$conteo,names.arg=R$principal_problema_estado)
D=R[R$conteo<Mediaoriginal,]
D$principal_problema_estado |> sort()
G=R[R$conteo>=Mediaoriginal,]

#No hay coincidencias con 2025


#Ahora las de pocas
Checar=names(A)[!(names(A) %in% c("principal_problema_estado","medio_de_comunicacion_informa_noticias",
                                               "donde_hay_mas_corrupcion","principal_delito","principal_problema_colonia",
                                  "zona_metropolitana","edad","escolaridad","ocupacion","PESOF"
                                               ))]

for(i in which(names(A) %in% Checar)){
  Respuestas= A |>
    dplyr::group_by(.data[[names(A)[i]]]) |>
    dplyr::summarise(conteo = dplyr::n())
  D=Respuestas[Respuestas$conteo<N*0.05,]
  G=Respuestas[Respuestas$conteo>=N*0.05,]
  if(nrow(D)>0){
    cat("Checar ",names(A)[i],"\n")
  }
}
#######
# #"P15"
# Respuestas= A |>
#   dplyr::group_by(P15) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]
# #NADA
#"P27"
# Respuestas= A |>
#   dplyr::group_by(P27) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]
#NADA
#"P39"
# Respuestas= A |>
#   dplyr::group_by(P39) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]
#Aquí hay que hacer algo

#"P45"
# Respuestas= A |>
#   dplyr::group_by(P45) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]

#"P51" 
# Respuestas= A |>
#   dplyr::group_by(P51) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]

#P64B6
Respuestas= A |>
  dplyr::group_by(gobierno_ayuda_contra_deterioro_calles_avenidas) |>
  dplyr::summarise(conteo = dplyr::n())
D=Respuestas[Respuestas$conteo<N*0.05,]
G=Respuestas[Respuestas$conteo>=N*0.05,]
#Aquí hay que hacer algo

A$gobierno_ayuda_contra_deterioro_calles_avenidas <- as.character(A$gobierno_ayuda_contra_deterioro_calles_avenidas)
A$gobierno_ayuda_contra_deterioro_calles_avenidas[A$gobierno_ayuda_contra_deterioro_calles_avenidas=="Mucho" |
                                                    A$gobierno_ayuda_contra_deterioro_calles_avenidas=="Muchísimo"]="Mucho / Muchísimo"
A$gobierno_ayuda_contra_deterioro_calles_avenidas <- as.factor(A$gobierno_ayuda_contra_deterioro_calles_avenidas)

#P86A1
# Respuestas= A |>
#   dplyr::group_by(P86A1) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]

#P8A1
Respuestas= A |>
  dplyr::group_by(situacion_municipio) |>
  dplyr::summarise(conteo = dplyr::n())
D=Respuestas[Respuestas$conteo<N*0.05,]
G=Respuestas[Respuestas$conteo>=N*0.05,]
A$situacion_municipio <- as.character(A$situacion_municipio)
A$situacion_municipio[A$situacion_municipio=="Bien" |
                        A$situacion_municipio=="Muy Bien"]="Bien / Muy bien"
A$situacion_municipio <- as.factor(A$situacion_municipio)

#P8A2
Respuestas= A |>
  dplyr::group_by(situacion_estado) |>
  dplyr::summarise(conteo = dplyr::n())
D=Respuestas[Respuestas$conteo<N*0.05,]
D[,1]
G=Respuestas[Respuestas$conteo>=N*0.05,]
A$situacion_estado <- as.character(A$situacion_estado)
A$situacion_estado[A$situacion_estado=="Bien" | A$situacion_estado=="Muy bien"]="Bien / Muy bien"
A$situacion_estado <- as.factor(A$situacion_estado)

#P9
# Respuestas= A |>
#   dplyr::group_by(P9) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]

#P23A1
Respuestas= A |>
  dplyr::group_by(principal_atributo_gobernador) |>
  dplyr::summarise(conteo = dplyr::n())
D=Respuestas[Respuestas$conteo<N*0.05,]
G=Respuestas[Respuestas$conteo>=N*0.05,]

A$principal_atributo_gobernador <- as.character(A$principal_atributo_gobernador)
A$principal_atributo_gobernador[A$principal_atributo_gobernador=="Con experiencia" | 
                                  A$principal_atributo_gobernador=="Con preparación"]="Con preparación / experiencia"
A$principal_atributo_gobernador <- as.factor(A$principal_atributo_gobernador)

# #P26
Respuestas= A |>
  dplyr::group_by(confianza_gobernador) |>
  dplyr::summarise(conteo = dplyr::n())
D=Respuestas[Respuestas$conteo<N*0.05,]
D[,1]
G=Respuestas[Respuestas$conteo>=N*0.05,]

A$confianza_gobernador <- as.character(A$confianza_gobernador)
A$confianza_gobernador[A$confianza_gobernador=="Mucha" |
                         A$confianza_gobernador=="Muchísima"]="Mucha / Muchísima"
A$confianza_gobernador <- as.factor(A$confianza_gobernador)
# 
# #P52
# Respuestas= A |>
#   dplyr::group_by(P52) |>
#   dplyr::summarise(conteo = dplyr::n())
# D=Respuestas[Respuestas$conteo<6060*0.05,]
# G=Respuestas[Respuestas$conteo>=6060*0.05,]

#####Regresion
A = A |> 
  dplyr::mutate(zona_metropolitana = relevel(x = zona_metropolitana, ref = "Sin zona"),
                Sexo = relevel(x = Sexo, ref = "Hombre"),
                escolaridad = relevel(x = escolaridad, ref = "Preparatoria completa"),
                ocupacion = relevel(x = ocupacion, ref = "No respuesta"),
                nivel_socieconomico = relevel(x = nivel_socieconomico, ref = "Media"),
                ingresos = relevel(x = ingresos, ref = "No sé"),
                inseguridad_comparada_año_anterior = relevel(x = inseguridad_comparada_año_anterior, ref = "No sé"),
                principal_problema_colonia = relevel(x = principal_problema_colonia, ref = "No sé"),
                seguridad_publica = relevel(x = seguridad_publica, ref = "No sé"),
                principal_delito = relevel(x = principal_delito, ref = "No sé"),
                corrupcion_en_gobierno_estatal = relevel(x = corrupcion_en_gobierno_estatal, ref = "No sé"),
                donde_hay_mas_corrupcion = relevel(x = donde_hay_mas_corrupcion, ref = "No sé"),
                corrupcion_comparar_morena_con_pri = relevel(x = corrupcion_comparar_morena_con_pri, ref = "No sé"),
                pobreza = relevel(x = pobreza, ref = "No sé"),
                afectado_deterioro_calles_avenidas = relevel(x = afectado_deterioro_calles_avenidas, ref = "Sí"),
                gobierno_ayuda_contra_deterioro_calles_avenidas = relevel(x = gobierno_ayuda_contra_deterioro_calles_avenidas, ref = "No sé"),
                salario_suficiente = relevel(x = salario_suficiente, ref = "No sé"),
                servicio_que_afecta_economia = relevel(x = servicio_que_afecta_economia, ref = "No sé"),
                medio_de_comunicacion_informa_noticias = relevel(x = medio_de_comunicacion_informa_noticias, ref = "No sé"),
                situacion_municipio = relevel(x = situacion_municipio, ref = "No sé"),
                situacion_estado = relevel(x = situacion_estado, ref = "No sé"),
                situacion_estado_comparado_año_anterior = relevel(x = situacion_estado_comparado_año_anterior, ref = "No sé"),
                principal_problema_estado = relevel(x = principal_problema_estado, ref = "No sé"),
                confianza_gobernador = relevel(x = confianza_gobernador, ref = "No sé"),
                hogar_recibe_algun_ayuda_del_gobierno = relevel(x = hogar_recibe_algun_ayuda_del_gobierno, ref = "Sí, usted")
  ) |> 
  dplyr::mutate(dplyr::across(tidyselect::where(is.factor), forcats::fct_drop))


Pro_binary.data2024=A

Regresion_Pre_2024=glm(formula = reformulate(names(binary.data2024)[2:37],"P19"),
                       family = binomial(link = "logit"), 
                       data = binary.data2024,
                       weights = binary.data2024$PESOF)
Pre_summary2024=summary(Regresion_Pre_2024)
Pre_coeficientes_significantes2024=Pre_summary2024[["coefficients"]][Pre_summary2024[["coefficients"]][,4]<0.01,]
library(DescTools)
Pre_pseudoR2_2024=PseudoR2(Regresion_Pre_2024, which = c("CoxSnell","Nagelkerke","McFadden"))



Regresion_Pos_2024=glm(reformulate(names(Pro_binary.data2024)[2:37],"P19"),
                      family = binomial(link = "logit"), 
                      data = Pro_binary.data2024, 
                      weights = Pro_binary.data2024$PESOF)
Pos_summary2024=summary(Regresion_Pos_2024)
Pos_coeficientes_significantes2024=Pos_summary2024[["coefficients"]][Pos_summary2024[["coefficients"]][,4]<0.01,]
Pos_pseudoR2_2024=PseudoR2(Regresion_Pos_2024, which = c("CoxSnell","Nagelkerke","McFadden"))